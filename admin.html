<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Klinik Pergigian Anda</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f0f2f5; color:#333; }

.header {
    background:#004aad; color:white;
    padding:15px 20px; display:flex; justify-content:space-between; align-items:center;
    box-shadow:0 2px 10px rgba(0,0,0,0.2);
}
.brand { display:flex; align-items:center; gap:10px; }
.brand img { width:38px; height:38px; border-radius:5px; background:white; }
.header h2 { margin:0; font-size:16px; text-transform:uppercase; font-weight:700; letter-spacing:1px; }

.btn-home {
    background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.5);
    padding:8px 15px; border-radius:50px; font-size:12px; color:white;
    font-weight:bold; text-decoration:none; transition:.3s;
}
.btn-home:hover { background:white; color:#004aad; }

.controls {
    background:white; padding:20px; text-align:center; border-bottom:1px solid #ddd;
}
input[type="date"] {
    padding:8px 15px; font-size:15px; border:1px solid #ccc;
    border-radius:5px; outline:none;
}

.container {
    max-width:800px; margin:0 auto; padding:20px 10px 50px;
}
.card {
    background:white; padding:15px; margin-bottom:12px; border-radius:10px;
    display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center;
    border-left:6px solid #ccc; box-shadow:0 2px 8px rgba(0,0,0,0.07);
}
.card.kosong { border-left-color:#4caf50; }
.card.pending { border-left-color:#ff9800; background:#fff8e1; }
.card.confirmed { border-left-color:#2196f3; }

.info { flex:1; min-width:110px; }
.info b { display:block; color:#004aad; font-size:16px; }

.details { flex:2; font-size:13px; line-height:1.4; }

.badge {
    display:inline-block; padding:2px 8px; border-radius:4px;
    font-size:10px; font-weight:700; color:white; margin-bottom:5px;
}
.badge-pending { background:#ff9800; }
.badge-confirmed { background:#2196f3; }

.actions {
    min-width:145px; display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end;
}
.actions button {
    padding:7px 10px; border:none; border-radius:6px; color:white;
    font-size:11px; font-weight:bold; cursor:pointer;
}
.btn-approve { background:#4caf50; }
.btn-reject { background:#f44336; }
.btn-block { background:#607d8b; }
</style>
</head>

<body>

<div class="header">
    <div class="brand">
        <img src="logo_klinikanda.jpg" alt="Logo">
        <h2>ADMIN PANEL</h2>
    </div>
    <a href="index.html" class="btn-home"><i class="fas fa-home"></i> LAMAN UTAMA</a>
</div>

<div class="controls">
    <label><i class="far fa-calendar"></i> Pilih Tarikh:</label><br><br>
    <input type="date" id="adminDate" onchange="loadAdminData()">
</div>

<div class="container" id="adminList">
    <p align="center">Memuatkan data...</p>
</div>

<script>
/* ⚠️ API ORIGINAL — TIDAK DIUSIK */
const API_URL = "https://script.google.com/macros/s/AKfycbxw7jOX0MnBN2-KD6KT3lbt7liDItNs5rtLLci486Iy0hEDYcXjfE7WKOaYQJnWd1xz/exec";

let adminToken = "";
checkAuth();

function checkAuth(){
    let p = prompt("Masukkan Password Admin:");
    if(p !== "Uni2025"){
        alert("Password salah.");
        window.location.href = "index.html";
    } else {
        adminToken = p;
        document.getElementById("adminDate").value = new Date().toISOString().split("T")[0];
        loadAdminData();
    }
}

async function loadAdminData(){
    document.getElementById("adminList").innerHTML = "<p align=center>Kemaskini...</p>";

    try {
        let res = await fetch(API_URL + "?date=" + document.getElementById("adminDate").value);
        let data = await res.json();
        renderAdmin(data.jadual);
    } catch(e){
        alert("Ralat server.");
    }
}

function renderAdmin(list){
    const box = document.getElementById("adminList");
    box.innerHTML = "";

    list.forEach(item=>{
        let d = item.data;
        let status = d.status || "kosong";

        let cardClass = "kosong";
        let infoHTML = `<span style='color:green;font-style:italic;'>— Slot kosong —</span>`;
        let buttons = `<button class='btn-block' onclick="blockSlot('${item.masa}')">Tutup Slot</button>`;

        if(status==="PENDING"){
            cardClass="pending";
            infoHTML = `
                <span class="badge badge-pending">MENUNGGU</span><br>
                <b>${d.nama}</b> (${d.phone})<br>
                Masalah: ${d.masalah}
            `;
            buttons = `
                <button class="btn-approve" onclick="processSlot('${item.masa}','CONFIRMED','${d.nama}','${d.phone}','${d.masalah}')">Sahkan</button>
                <button class="btn-reject" onclick="processSlot('${item.masa}','DELETE','${d.nama}','${d.phone}')">Padam</button>
            `;
        }

        if(status==="CONFIRMED"){
            cardClass="confirmed";
            infoHTML = `
                <span class="badge badge-confirmed">DISAHKAN</span><br>
                <b>${d.nama}</b> (${d.phone})<br>
                Masalah: ${d.masalah}
            `;
            buttons = `
                <button class="btn-reject" style="background:#444;" onclick="processSlot('${item.masa}','DELETE','${d.nama}','${d.phone}')">Batal</button>
            `;
        }

        box.innerHTML += `
            <div class="card ${cardClass}">
                <div class="info">
                    <b>${item.masa}</b>
                    <span>${item.service}</span>
                </div>
                <div class="details">${infoHTML}</div>
                <div class="actions">${buttons}</div>
            </div>
        `;
    });
}

async function processSlot(time, action, nama, phone, masalah){
    if(!confirm("Teruskan?")) return;

    await fetch(API_URL, {
        method:"POST",
        body:JSON.stringify({
            type:"ADMIN_UPDATE",
            password:adminToken,
            date:document.getElementById("adminDate").value,
            masa:time,
            action
        })
    });

    let tarikh = document.getElementById("adminDate").value;

    let msg = (action==="CONFIRMED")
        ? `Salam ${nama}, tempahan anda telah DISAHKAN.\nTarikh: ${tarikh}\nMasa: ${time}\nMasalah: ${masalah}.`
        : `Salam ${nama}, tempahan anda bagi ${tarikh} jam ${time} telah dibatalkan.`;

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`);
    loadAdminData();
}

async function blockSlot(time){
    if(!confirm("Tutup slot ini?")) return;

    await fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
            type:"BOOKING",
            date:document.getElementById("adminDate").value,
            masa:time,
            nama:"SLOT DITUTUP",
            phone:"-",
            masalah:"Manual Close"
        })
    });

    loadAdminData();
}
</script>

</body>
</html>
